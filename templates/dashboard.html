{% extends "base.html" %}

{% block title %}Network Command Center{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-8">
        <h2 class="mb-0 text-uppercase"><i class="fa-solid fa-satellite-dish me-2 text-primary-accent"></i>Network <span class="text-primary-accent">Command Center</span></h2>
        <p class="text-secondary mb-0">Monitoreo Avanzado de Tráfico, Latencia y Conexiones</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="glass-badge d-inline-block">
            <i class="fa-solid fa-server me-1"></i> 
            <span id="publicIP" class="{% if user.settings and not user.settings.show_public_ip %}blur-ip{% endif %}">Detectando IP...</span>
            <button class="btn btn-xs btn-link text-secondary p-0 ms-2" onclick="toggleIpVisibility()">
                <i class="fa-solid {% if user.settings and not user.settings.show_public_ip %}fa-eye{% else %}fa-eye-slash{% endif %}" id="eyeIcon"></i>
            </button>
        </div>
        <div class="glass-badge d-inline-block ms-2">
            <i class="fa-regular fa-clock me-1"></i> <span id="systemTime">--:--:--</span>
        </div>
    </div>
</div>

<script>
    // Pass settings to JS
    const SHOW_IP_DEFAULT = {{ 'true' if user.settings and user.settings.show_public_ip else 'false' }};
    let showIp = SHOW_IP_DEFAULT;
</script>

<!-- TOP ROW: GLOBAL STATS -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card h-100 border-primary bg-opacity-10" style="background: rgba(13, 110, 253, 0.05);">
            <div class="card-body text-center">
                <h6 class="text-secondary text-uppercase mb-2">Velocidad de Bajada</h6>
                <h2 class="display-5 fw-bold text-success mb-0"><i class="fa-solid fa-arrow-down fa-xs me-2"></i><span id="globalDownload">0</span> <small class="fs-6">KB/s</small></h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-danger bg-opacity-10" style="background: rgba(220, 53, 69, 0.05);">
            <div class="card-body text-center">
                <h6 class="text-secondary text-uppercase mb-2">Velocidad de Subida</h6>
                <h2 class="display-5 fw-bold text-danger mb-0"><i class="fa-solid fa-arrow-up fa-xs me-2"></i><span id="globalUpload">0</span> <small class="fs-6">KB/s</small></h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <h6 class="text-secondary text-uppercase mb-2">Latencia (Ping Google)</h6>
                <h2 class="display-5 fw-bold text-warning mb-0"><i class="fa-solid fa-stopwatch fa-xs me-2"></i><span id="pingValue">--</span> <small class="fs-6">ms</small></h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <h6 class="text-secondary text-uppercase mb-2">Carga del Sistema</h6>
                <div class="d-flex justify-content-center gap-3 mt-2">
                    <div>
                        <span class="d-block text-secondary small">CPU</span>
                        <span id="cpuValue" class="fw-bold fs-4">0%</span>
                    </div>
                    <div class="vr"></div>
                    <div>
                        <span class="d-block text-secondary small">RAM</span>
                        <span id="ramValue" class="fw-bold fs-4">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MIDDLE ROW: INTERFACE MONITOR & LATENCY GRAPH -->
<div class="row g-4 mb-4">
    <!-- Interface Traffic -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <i class="fa-solid fa-chart-area"></i>
                    <select id="interfaceSelect" class="form-select form-select-sm" style="width: auto;">
                        <option value="total" selected>Todas las Interfaces</option>
                    </select>
                </div>
                <span class="badge bg-info bg-opacity-25 text-info border border-info rounded-pill">
                    IP: <span id="interfaceIP" class="{% if user.settings and not user.settings.show_public_ip %}blur-ip{% endif %}">--</span>
                </span>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="networkChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ping Latency Graph -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fa-solid fa-wave-square me-2"></i>Estabilidad (Ping)
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:100%; width:100%">
                    <canvas id="pingChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SERVICES ROW -->
<div class="row g-4 mb-4">
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fa-solid fa-server me-2"></i>Monitoreo de Servicios & Dispositivos</span>
                <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#serviceModal" onclick="resetServiceForm()">
                    <i class="fa-solid fa-plus me-1"></i>Agregar
                </button>
            </div>
            <div class="card-body p-0">
                 <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 align-middle">
                        <thead class="bg-secondary bg-opacity-25">
                            <tr>
                                <th class="ps-4">Nombre</th>
                                <th>Objetivo (URL/IP)</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th>Latencia</th>
                                <th class="text-end pe-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="servicesTableBody">
                            <tr><td colspan="6" class="text-center text-muted py-3">Cargando monitores...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NETWORK SCANNER -->
    <div class="col-lg-5">
        <div class="card h-100">
             <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fa-solid fa-network-wired me-2"></i>Dispositivos en Red (ARP)</span>
                <button class="btn btn-sm btn-outline-info" onclick="scanNetwork()">
                    <i class="fa-solid fa-rotate me-1"></i>Escanear
                </button>
            </div>
             <div class="card-body p-0">
                 <div class="table-responsive" style="max-height: 300px;">
                    <table class="table table-dark table-hover mb-0 align-middle">
                        <thead class="bg-secondary bg-opacity-25">
                            <tr>
                                <th class="ps-4">IP</th>
                                <th>MAC</th>
                                <th class="text-end pe-4">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="networkScanBody">
                            <tr><td colspan="3" class="text-center text-muted py-3">Haz clic en Escanear para buscar dispositivos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BOTTOM ROW: ACTIVE CONNECTIONS -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fa-solid fa-diagram-project me-2"></i>Conexiones Activas (Top 15)</span>
                <span class="badge bg-secondary">Actualización en tiempo real</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 align-middle">
                        <thead class="bg-secondary bg-opacity-25">
                            <tr>
                                <th class="ps-4">Proceso</th>
                                <th>PID</th>
                                <th>Local Address</th>
                                <th>Remote Address</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="connectionsTableBody">
                            <tr>
                                <td colspan="5" class="text-center py-3 text-secondary">Cargando conexiones...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Add/Edit Service -->
<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark border border-secondary text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="serviceModalLabel">Agregar Monitor</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="serviceForm">
          <input type="hidden" id="serviceId">
          <div class="mb-3">
            <label for="serviceName" class="form-label text-secondary">Nombre Descriptivo</label>
            <input type="text" class="form-control bg-dark text-white border-secondary" id="serviceName" placeholder="Ej. Mi Celular, Google" required>
          </div>
          <div class="mb-3">
            <label for="serviceUrl" class="form-label text-secondary">Objetivo (URL o IP)</label>
            <input type="text" class="form-control bg-dark text-white border-secondary" id="serviceUrl" placeholder="Ej. 192.168.1.50 o https://google.com" required>
          </div>
          <div class="mb-3">
            <label for="serviceType" class="form-label text-secondary">Tipo de Monitoreo</label>
            <select class="form-select bg-dark text-white border-secondary" id="serviceType">
              <option value="http">HTTP (Web)</option>
              <option value="ping">Ping (ICMP)</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="saveService()">Guardar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
    // Clock
    setInterval(() => {
        const now = new Date();
        document.getElementById('systemTime').innerText = now.toLocaleTimeString();
    }, 1000);
</script>
{% endblock %}
